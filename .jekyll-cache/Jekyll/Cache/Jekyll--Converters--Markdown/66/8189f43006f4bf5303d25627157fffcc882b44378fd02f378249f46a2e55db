I"¸9<p>èƒŒæ™¯ï¼š</p>

<blockquote>
  <p>ä¸ºäº†é˜²æ­¢ç”¨æˆ·åœ¨å‡çº§åˆ°iOS14çš„æ—¶å€™å‡ºç°ä¸å…¼å®¹çš„æƒ…å†µï¼Œä¹Ÿä¸ºäº†æå‡ç”¨æˆ·å‡çº§ç³»ç»Ÿçš„å¹³æ»‘æ„Ÿã€‚</p>

  <p>åŒæ—¶ä¸ºäº†ç»Ÿè®¡ï¼Œå¹¿å‘Šï¼Œå½’å› çš„ä¸€ç³»åˆ—åŠŸèƒ½çš„åœ¨ç³»ç»Ÿå‡çº§æ—¶ä¸å‡ºç°ç©ºçª—æœŸã€‚</p>

  <p>å¼€å‘è€…ä¸èƒ½ç­‰åˆ°iOSå‘å¸ƒï¼Œä»¥åŠXcode12å‘å¸ƒä¹‹åå†å»é’ˆå¯¹Appè¿›è¡Œä¼˜åŒ–æˆ–è€…å¼ºåˆ¶è¦æ±‚æ›´æ–°ã€‚</p>

  <p>é’ˆå¯¹Xcode12 Betaç‰ˆä¸èƒ½æ‰“åŒ…ä¸Šæ¶ï¼Œä»¥åŠXcode11æ— æ³•ä½¿ç”¨AppTrackingTransparencyç³»ç»Ÿåº“çš„é—®é¢˜ï¼Œå¸®åŠ©å¼€å‘è€…æå‰é€‚é…iOS 14 IDFAï¼Œæ˜¯æœ¬æ–‡è¦è§£å†³çš„é—®é¢˜ã€‚</p>
</blockquote>

<h3 id="ä¸€å˜åŒ–">ä¸€ã€å˜åŒ–</h3>

<p>iOS 14 Appleå¯¹éšç§å¢åŠ äº†æ›´å¼ºçš„ä¿æŠ¤ï¼Œé¦–å½“å…¶å†²å—å½±å“çš„å°±æ˜¯IDFAã€‚</p>

<p>åœ¨LATï¼ˆLimit Ad Trackingï¼‰çš„æœºåˆ¶ä¸‹åˆå¢åŠ ATTï¼ˆAppTrackingTransparencyï¼‰æœºåˆ¶ã€‚</p>

<h3 id="äºŒattæœºåˆ¶ç‰¹ç‚¹">äºŒã€ATTæœºåˆ¶ç‰¹ç‚¹</h3>

<h4 id="1å‰ç½®äºlatæœºåˆ¶å½“æ²¡æœ‰attçš„æ—¶å€™latä¸ç”Ÿæ•ˆ">1ã€å‰ç½®äºLATæœºåˆ¶ï¼Œå½“æ²¡æœ‰ATTçš„æ—¶å€™ï¼ŒLATä¸ç”Ÿæ•ˆ</h4>

<p>åœ¨iOS 14çš„ç³»ç»Ÿä¸Šå¦‚æœä¸ä½¿ç”¨ATTå‘ç”¨æˆ·è¯·æ±‚IDFAçš„ä½¿ç”¨æƒé™çš„è¯ï¼Œåœ¨è®¾ç½®é‡Œä¹Ÿä¸ä¼šæœ‰ï¼Œå³ä¸ä¸»åŠ¨è¯·æ±‚æƒé™ï¼Œç”¨æˆ·ä¹Ÿæ²¡åŠæ³•ä¸»åŠ¨å¼€å¯</p>

<h4 id="2å¯ä»¥ç»†åŒ–åˆ°é’ˆå¯¹ä¸åŒappå¯ç”¨ä¸åŒçš„è®¾ç½®">2ã€å¯ä»¥ç»†åŒ–åˆ°é’ˆå¯¹ä¸åŒAppå¯ç”¨ä¸åŒçš„è®¾ç½®</h4>

<p>ä¹‹å‰LATæ˜¯é’ˆå¯¹ç³»ç»Ÿçš„ï¼ŒATTå¯ä»¥åœ¨æ€»å¼€å…³ä¹‹å¤–ï¼Œå•ç‹¬å¯¹Appè¿›è¡Œè®¾ç½®ã€‚ä»¥å‰ä¸€ä¸ªAppç§æ ‘ï¼Œå¤§å®¶ä¹˜å‡‰çš„åœºæ™¯è¦æ¶ˆå¤±äº†ï¼Œç°åœ¨éœ€è¦æ¯ä¸ªAppéƒ½è¦å‘ç”¨æˆ·è¯·æ±‚IDFAæƒé™</p>

<p><br />
<img src="../images/xcode11idfa/4.png" alt="Alt text" /></p>

<p><br /></p>
<h4 id="3éœ€è¦å’Œå®šä½ç›¸æœºç­‰æƒé™ä¸€æ ·åœ¨infoplitsä¸­å£°æ˜æƒé™å¹¶è¯´æ˜ä½¿ç”¨ç›®çš„">3ã€éœ€è¦å’Œå®šä½ç›¸æœºç­‰æƒé™ä¸€æ ·ï¼Œåœ¨info.plitsä¸­å£°æ˜æƒé™ï¼Œå¹¶è¯´æ˜ä½¿ç”¨ç›®çš„</h4>

<p><img src="../images/xcode11idfa/5.png" alt="Alt text" /></p>

<h3 id="ä¸‰ä½¿ç”¨att">ä¸‰ã€ä½¿ç”¨ATT</h3>

<h4 id="1è·å–å½“å‰appç”¨æˆ·æˆæƒçŠ¶æ€">1ã€è·å–å½“å‰Appï¼Œç”¨æˆ·æˆæƒçŠ¶æ€</h4>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">+ requestTrackingAuthorizationWithCompletionHandler:</code>
The request for user authorization to access app-related data.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ATTrackingManagerAuthorizationStatus states = [ATTrackingManager trackingAuthorizationStatus];
</code></pre></div></div>

<p><br /></p>
<h4 id="2åˆ¤æ–­ç”¨æˆ·çš„æˆæƒçŠ¶æ€">2ã€åˆ¤æ–­ç”¨æˆ·çš„æˆæƒçŠ¶æ€</h4>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">trackingAuthorizationStatus</code> The authorization status that is current for the calling application.</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef NS_ENUM(NSUInteger, ATTrackingManagerAuthorizationStatus) {
    ATTrackingManagerAuthorizationStatusNotDetermined = 0,
    ATTrackingManagerAuthorizationStatusRestricted,
    ATTrackingManagerAuthorizationStatusDenied,
    ATTrackingManagerAuthorizationStatusAuthorized
} NS_SWIFT_NAME(ATTrackingManager.AuthorizationStatus) API_AVAILABLE(ios(14), macosx(10.16), tvos(14));
</code></pre></div></div>

<p>å…¶ä¸­</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ATTrackingManagerAuthorizationStatusNotDetermined</code> æœªå‘ç”¨æˆ·è¯·æ±‚æˆæƒ</li>
  <li><code class="language-plaintext highlighter-rouge">ATTrackingManagerAuthorizationStatusRestricted</code> ç”¨æˆ·åœ¨ç³»ç»Ÿçº§åˆ«å¼€å¯äº†é™åˆ¶å¹¿å‘Šè¿½è¸ª</li>
  <li><code class="language-plaintext highlighter-rouge">ATTrackingManagerAuthorizationStatusDenied</code> ç”¨æˆ·æ‹’ç»å‘Appæˆæƒ</li>
  <li><code class="language-plaintext highlighter-rouge">ATTrackingManagerAuthorizationStatusAuthorized</code> ç”¨æˆ·åŒæ„å‘Appæˆæƒ</li>
</ul>

<p><br /></p>
<h4 id="3å‘ç”¨æˆ·è¯·æ±‚æˆæƒ">3ã€å‘ç”¨æˆ·è¯·æ±‚æˆæƒ</h4>

<ul>
  <li>
    <p>å½“<code class="language-plaintext highlighter-rouge">states</code>ä¸º<code class="language-plaintext highlighter-rouge">ATTrackingManagerAuthorizationStatusAuthorized</code> å¯ä»¥ä½¿ç”¨IDFA</p>
  </li>
  <li>
    <p>å½“<code class="language-plaintext highlighter-rouge">states</code>ä¸º<code class="language-plaintext highlighter-rouge">ATTrackingManagerAuthorizationStatusRestricted</code>å’Œ<code class="language-plaintext highlighter-rouge">ATTrackingManagerAuthorizationStatusDenied</code>æ—¶éœ€è¦å‘ç”¨æˆ·å¼¹çª—è¯·æ±‚ç”¨æˆ·ä¸»åŠ¨å»è®¾ç½®é‡Œå…³é—­<code class="language-plaintext highlighter-rouge">é™åˆ¶å¹¿å‘Šè¿½è¸ª</code></p>

    <p><img src="../images/xcode11idfa/6.png" style="zoom:50%" /></p>
  </li>
</ul>

<p><br /></p>

<ul>
  <li>
    <p>å½“<code class="language-plaintext highlighter-rouge">states</code>ä¸º<code class="language-plaintext highlighter-rouge">ATTrackingManagerAuthorizationStatusNotDetermined</code> å‘ç”¨æˆ·å‘èµ·è¯·æ±‚æˆæƒ</p>

    <p><img src="../images/xcode11idfa/7.png" style="zoom:50%" /></p>
  </li>
</ul>

<p><br /></p>
<h4 id="4å…¨éƒ¨æµç¨‹ä»£ç ">4ã€å…¨éƒ¨æµç¨‹ä»£ç </h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// iOS 14è¯·æ±‚idfaæƒé™
if (@available(iOS 14.0, *)) {
    ATTrackingManagerAuthorizationStatus states = [ATTrackingManager trackingAuthorizationStatus];
    if (states == ATTrackingManagerAuthorizationStatusNotDetermined) {
        // æœªæç¤ºç”¨æˆ·
        
        [ATTrackingManager requestTrackingAuthorizationWithCompletionHandler:^(ATTrackingManagerAuthorizationStatus status) {
            dispatch_async(dispatch_get_main_queue(), ^{
                // è·å–åˆ°æƒé™åï¼Œä¾ç„¶ä½¿ç”¨è€æ–¹æ³•è·å–idfa
                if (status == ATTrackingManagerAuthorizationStatusAuthorized) {
                    
                }
                else {
                    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"" message:XYLocalizedString(@"è¯·åœ¨è®¾ç½®-éšç§-Trackingä¸­å…è®¸Appè¯·æ±‚è·Ÿè¸ª") preferredStyle:UIAlertControllerStyleAlert];
                    UIAlertAction *action2 = [UIAlertAction actionWithTitle:XYLocalizedString(@"ç¡®è®¤") style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {}];
                    [alert addAction:action2];
                    [self presentViewController:alert animated:YES completion:nil];
                }
            });
        }];
    }
    else if (states == ATTrackingManagerAuthorizationStatusRestricted) {
        // é™åˆ¶ä½¿ç”¨
        UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"" message:XYLocalizedString(@"è¯·åœ¨è®¾ç½®-éšç§-Trackingä¸­å…è®¸Appè¯·æ±‚è·Ÿè¸ª") preferredStyle:UIAlertControllerStyleAlert];
        UIAlertAction *action2 = [UIAlertAction actionWithTitle:XYLocalizedString(@"ç¡®è®¤") style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {}];
        [alert addAction:action2];
        [self presentViewController:alert animated:YES completion:nil];
    }
    else if (states == ATTrackingManagerAuthorizationStatusDenied) {
        // æ‹’ç»
        UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"" message:XYLocalizedString(@"è¯·åœ¨è®¾ç½®-éšç§-Trackingä¸­å…è®¸Appè¯·æ±‚è·Ÿè¸ª") preferredStyle:UIAlertControllerStyleAlert];
        UIAlertAction *action2 = [UIAlertAction actionWithTitle:XYLocalizedString(@"ç¡®è®¤") style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {}];
        [alert addAction:action2];
        [self presentViewController:alert animated:YES completion:nil];
    }
    else if (states == ATTrackingManagerAuthorizationStatusAuthorized) {
        // å¯ä»¥ä½¿ç”¨IDFA
    }
}
// iOS 14ä»¥ä¸‹è¯·æ±‚idfaæƒé™
else {
    BOOL b = [XYSystemUtil canUseIDFA];
    if (!b) {
        UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"" message:XYLocalizedString(@"è¯·åœ¨è®¾ç½®-éšç§-å¹¿å‘Šä¸­å…è®¸Appè¯·æ±‚è·Ÿè¸ª") preferredStyle:UIAlertControllerStyleAlert];
        UIAlertAction *action2 = [UIAlertAction actionWithTitle:XYLocalizedString(@"ç¡®è®¤") style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {}];
        [alert addAction:action2];
        [self presentViewController:alert animated:YES completion:nil];
    }
    else {
    	// å¯ä»¥ä½¿ç”¨IDFA
    }
}
</code></pre></div></div>

<p><br /></p>
<h3 id="å››æµ‹è¯•ä»¥åŠä¸Šæ¶é‡ç‚¹æ¥äº†">å››ã€æµ‹è¯•ä»¥åŠä¸Šæ¶ï¼ˆé‡ç‚¹æ¥äº†ï¼‰</h3>

<p>çŸ›ç›¾ç‚¹</p>

<ul>
  <li>
    <p>Xcode11æ²¡æœ‰iOS14ç³»ç»Ÿåº“ï¼ŒXcode12 Betaç‰ˆæ— æ³•ä¸Šæ¶</p>
  </li>
  <li>
    <p>é’ˆå¯¹iOS14å’Œä»¥ä¸‹ç³»ç»Ÿå•ç‹¬åšé€‚é…</p>
  </li>
</ul>

<p>é’ˆå¯¹ä¸Šæ¶ï¼Œç¬”è€…æµ‹è¯•äº†ä¸‰ç§æƒ…å†µ</p>

<ul>
  <li>
    <p>ä½¿ç”¨Xcode12 Betaç¼–è¯‘æ‰“åŒ…ç›´æ¥ä¸Šä¼ ï¼Œä¼šç›´æ¥æ— æ³•ä¸Šä¼ ï¼Œæç¤º</p>

    <blockquote>
      <p>ERROR ITMS-90534: â€œInvalid Toolchain. Your app was built with an unsupported SDK or version of Xcode. If you plan to submit this build to the App Store, make sure you are using the versions listed in https://help.apple.com/xcode/mac/current/#/devf16aefe3b or later.â€</p>
    </blockquote>
  </li>
  <li>
    <p>ä½¿ç”¨Xcode12 Betaæ‰“åŒ…ï¼Œå¹¶ä¿®æ”¹ipaä¸­info.plisté‡Œçš„Xcodeç‰ˆæœ¬å·ï¼Œå¯ä»¥æ­£å¸¸ä¸Šä¼ åˆ°Connectï¼Œä½†æ˜¯æå®¡ä¹‹åä¼šæ”¶åˆ°é‚®ä»¶</p>

    <blockquote>
      <p>The status of your app has changed to Invalid Binary.</p>
    </blockquote>
  </li>
  <li>
    <p>ä½¿ç”¨Xcode11 Link iOS14ç³»ç»Ÿåº“ï¼Œç„¶åæ‰“åŒ…ä¸Šä¼ ï¼Œåœ¨æœºå®¡ä¹‹åä¼šæç¤º</p>

    <blockquote>
      <p>æ­¤æ„å»ºç‰ˆæœ¬æ— æ•ˆã€‚ITMS-90562: Invalid Bundle - One or more dynamic libraries that are referenced by your app are not present in the dylib search path.</p>
    </blockquote>
  </li>
</ul>

<p><br /></p>
<h4 id="æœ€åè§£å†³æ–¹æ¡ˆæ˜¯">æœ€åè§£å†³æ–¹æ¡ˆæ˜¯</h4>

<ul>
  <li>IDEå±‚é¢ï¼ŒXcode11 Link Xcode12 Betaç‰ˆä¸­çš„iOS14ç³»ç»Ÿåº“</li>
  <li>ç¼–è¯‘æ‰“åŒ…å±‚é¢ï¼Œä»£ç ä¸­ä¸å¼ºåˆ¶Link <code class="language-plaintext highlighter-rouge">AppTrackingTransparency.framework</code>ç³»ç»Ÿåº“</li>
  <li>ä»£ç ç¼–å†™å±‚é¢ï¼Œä½¿ç”¨åŠ¨æ€Linkç³»ç»Ÿåº“ï¼Œä»¥åŠruntimeè°ƒç”¨å¯¹åº”çš„æ–¹æ³•</li>
</ul>

<p><br /></p>
<h4 id="ç¬¬ä¸€æ­¥">ç¬¬ä¸€æ­¥</h4>

<p>ä¸ºäº†èƒ½ä½¿ç”¨Xcode11æ¥æµ‹è¯•å’Œè°ƒè¯•ATTï¼Œæˆ‘ä»¬éœ€è¦å°†Xcode12 Betaç‰ˆä¸­çš„<code class="language-plaintext highlighter-rouge">AppTrackingTransparency.framework</code>copyåˆ°Xcode11åŒç›®å½•ä¸‹</p>

<p>Xcode12 Betaç‰ˆä¸­çš„<code class="language-plaintext highlighter-rouge">AppTrackingTransparency.framework</code>çš„è·¯å¾„å¦‚ä¸‹</p>

<ul>
  <li>
    <p>çœŸæœº</p>

    <p><code class="language-plaintext highlighter-rouge">/Applications/Xcode-beta.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk/System/Library/Frameworks/AppTrackingTransparency.framework</code></p>
  </li>
  <li>
    <p>æ¨¡æ‹Ÿå™¨</p>

    <p><code class="language-plaintext highlighter-rouge">/Applications/Xcode-beta.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/Frameworks/AppTrackingTransparency.framework</code></p>
  </li>
</ul>

<p>å®Œæˆæ­¤æ­¥ä¹‹åï¼Œå³å¯åœ¨æµ‹è¯•å’Œè°ƒè¯•çš„æ—¶å€™ä½¿ç”¨Xcode11ä½¿ç”¨ATT</p>

<p><br /></p>
<h4 id="ç¬¬äºŒæ­¥">ç¬¬äºŒæ­¥</h4>

<p>å› åœ¨Xcode11ä¸Šä½¿ç”¨iOS13 SDK æ¥Deployment Targetï¼Œä¼šå¯¼è‡´åœ¨ä½ç‰ˆæœ¬æ‰‹æœºä¸Šæ— æ³•Linké«˜ç‰ˆæœ¬ç³»ç»Ÿåº“ï¼Œä»è€ŒCrashï¼ŒæŠ¥é”™</p>

<blockquote>
  <p>dyld: Library not loaded: /System/Library/Frameworks/AppTrackingTransparency.framework/AppTrackingTransparency</p>

  <p>Reason: image not found</p>
</blockquote>

<p>æ‰€ä»¥éœ€è¦<code class="language-plaintext highlighter-rouge">åŠ¨æ€Linkç³»ç»Ÿåº“ï¼Œä»¥åŠruntimeè°ƒç”¨å¯¹åº”çš„æ–¹æ³•</code></p>

<p>å…ˆåˆ›å»ºå¯¹åº”çš„Runtimeåå°„ç±»<code class="language-plaintext highlighter-rouge">XYATTrackingManager</code></p>

<p>å¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">XYATTrackingManager.h</code>å®Œå…¨copyè‡ª<code class="language-plaintext highlighter-rouge">ATTrackingManager.h</code>,å¹¶å°†ç±»åç”±<code class="language-plaintext highlighter-rouge">ATTrackingManager</code>æ”¹ä¸º<code class="language-plaintext highlighter-rouge">XYATTrackingManager</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import &lt;Foundation/Foundation.h&gt;
#import &lt;os/availability.h&gt;

typedef NS_ENUM(NSUInteger, ATTrackingManagerAuthorizationStatus) {
    ATTrackingManagerAuthorizationStatusNotDetermined = 0,
    ATTrackingManagerAuthorizationStatusRestricted,
    ATTrackingManagerAuthorizationStatusDenied,
    ATTrackingManagerAuthorizationStatusAuthorized
} NS_SWIFT_NAME(ATTrackingManager.AuthorizationStatus) API_AVAILABLE(ios(14), macosx(10.16), tvos(14));

API_AVAILABLE(ios(14), macosx(10.16), tvos(14))
@interface XYATTrackingManager : NSObject

/*!
 * @property trackingAuthorizationStatus
 *
 * @abstract
 * Returns information about your applicationâ€™s tracking authorization status.
 * Users are able to grant or deny developers tracking privileges on a per-app basis.
 * Application developers must call `requestTrackingAuthorizationWithCompletionHandler:` for the ability to track users.
 *
 * @result
 * The current authorization status. If the user has not yet been prompted to approve access, the return value will either be
 * ATTrackingManagerAuthorizationStatusNotDetermined, or ATTrackingManagerAuthorizationStatusRestricted if this value is managed.
 * Once the user has been prompted, the return value will be either ATTrackingManagerAuthorizationStatusDenied or ATTrackingManagerAuthorizationStatusAuthorized.
 */
@property (class, nonatomic, readonly, assign) ATTrackingManagerAuthorizationStatus trackingAuthorizationStatus;

/*!
 * @method requestTrackingAuthorizationWithCompletionHandler:completion:
 *
 * @abstract
 * Request user tracking authorization with a completion handler returning the user's authorization status.
 * Users are able to grant or deny developers tracking privileges on a per-app basis.
 * This method allows developers to determine if access has been granted. On first use, this method will prompt the user to grant or deny access.
 *
 * The completion handler will be called with the result of the user's decision for granting or denying permission to use application tracking.
 * The completion handler will be called immediately if access to request authorization is restricted.
 */
+ (void)requestTrackingAuthorizationWithCompletionHandler:(void(^)(ATTrackingManagerAuthorizationStatus status))completion;

// This class, at this time, should not be instantiated.
+ (instancetype)new NS_UNAVAILABLE;

// This class, at this time, should not be instantiated.
- (instancetype)init NS_UNAVAILABLE;

@end
</code></pre></div></div>

<p>s</p>
:ET